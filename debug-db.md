# 数据库问题调试指南

## 问题描述
在 macOS 环境下，上传图片成功后出现 "database disk image is malformed" 错误，导致无法保存图片元数据到数据库。

## 已修复的问题

### 1. 数据库加载时序问题
- 增加了数据库连接关闭的等待时间（从 100ms 增加到 500ms）
- 增加了文件写入后的等待时间（从 100ms 增加到 800ms）
- 在重新加载数据库后立即验证完整性

### 2. 数据库写入错误恢复
- 为所有数据库写入操作添加了重试机制（最多3次）
- 在检测到 "database disk image is malformed" 错误时，自动执行数据库完整性检查和修复
- 添加了 VACUUM 操作来修复轻微的数据库损坏

### 3. 数据库操作同步
- 在保存图片元数据前增加了 200ms 的等待时间
- 改进了数据库操作的互斥锁机制
- 添加了详细的日志记录

## 测试步骤

1. 重启应用程序
2. 配置 COS 参数并保存
3. 上传一张图片
4. 观察控制台日志，应该看到：
   ```
   开始保存图片元数据到数据库...
   保存图片到数据库 (尝试 1/3): filename.webp
   ✅ 图片记录插入成功
   ✅ 图片数据库保存完成
   ```
5. 检查数据种子状态是否正常更新

## 如果问题仍然存在

1. 检查 macOS 的应用权限设置
2. 查看 Tauri 应用的数据目录权限
3. 尝试清理应用数据并重新初始化

## 数据库文件位置
macOS: `~/Library/Application Support/com.imsheet-tauri.app/imsheet.db`
